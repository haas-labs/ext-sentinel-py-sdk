name: Test Suite

on:
  pull_request:
    paths-ignore:
    - "docker/**"
    - "docs/**"
    - "samples/**"

jobs:

  checks:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version:
          - "3.11"

    steps:
    
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
 
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-west-1

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: "pip"

    - name: Install deployment tools
      run: |
        ./scripts/install deployment-tools

    - name: Setup AWS Code Artifactory access
      run: |
        aws codeartifact login \
          --tool twine \
          --repository sentinel-pypi \
          --domain haas \
          --domain-owner ${{ secrets.AWS_ACCOUNT_ID}} \
          --region eu-west-1

    - name: Install required packages and tools
      run: |
        ./scripts/install dev-tools
        ./scripts/install sentinel

    - name: Run tests
      run: |
        ./scripts/test ${{ matrix.python-version }}

    - name: Build and deploy to AWS Code Artifact
      run: |
        ./scripts/build
        cat ~/.pypirc
        # twine upload --repository codeartifact mypackage-1.0.tgz
